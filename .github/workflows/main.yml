name: Build and Publish Release

on:
  workflow_dispatch:
    inputs:
      release_name:
        description: 'Release name'
        required: true
      tag:
        description: 'Tag (e.g., v1.0.0)'
        required: true
      prerelease:
        description: 'Is this a prerelease?'
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      git_commit:
        description: 'Git commit SHA to reset to (optional)'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for git reset

      - name: Optionally reset to specified commit
        if: ${{ github.event.inputs.git_commit != '' }}
        run: |
          git reset --hard ${{ github.event.inputs.git_commit }}
          git clean -fdx

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Publish application
        run: |
          dotnet publish \
            -c Release \
            -f net9.0 \
            -r linux-x64 \
            --self-contained true \
            /p:PublishSingleFile=true \
            /p:IncludeNativeLibrariesForSelfExtract=true \
            /p:IncludeAllContentForSelfExtract=true \
            /p:DeleteExistingFiles=true \
            -o ./publish

      - name: Copy icons to publish directory
        run: |
          cp DivAcerManagerMax/icon.png ./publish/
          cp DivAcerManagerMax/iconTransparent.png ./publish/

      - name: Prepare compressed archives
        run: |
          # Find main binary
          BIN=$(find ./publish -maxdepth 1 -type f -executable -name 'DivAcerManagerMax*' ! -name '*.pdb' | head -n1)
          # Create DAMX-GUI.tar.xz with icon.png, iconTransparent.png, and main binary
          tar -C ./publish -cf DAMX-GUI.tar \
            $(basename "$BIN") \
            icon.png \
            iconTransparent.png
          xz -9e --threads=0 DAMX-GUI.tar
          # Create DivAcerManagerMax.pdb.tar.xz for PDB
          if [ -f ./publish/DivAcerManagerMax.pdb ]; then
            tar -C ./publish -cf DivAcerManagerMax.pdb.tar DivAcerManagerMax.pdb
            xz -9e --threads=0 DivAcerManagerMax.pdb.tar
          fi

      - name: Upload DAMX-GUI archive
        uses: actions/upload-artifact@v4
        with:
          name: DAMX-GUI
          path: DAMX-GUI.tar.xz

      - name: Upload PDB archive (if present)
        if: ${{ hashFiles('DivAcerManagerMax.pdb.tar.xz') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: DivAcerManagerMax-pdb
          path: DivAcerManagerMax.pdb.tar.xz

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download DAMX-GUI archive
        uses: actions/download-artifact@v4
        with:
          name: DAMX-GUI

      - name: Download PDB archive
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: DivAcerManagerMax-pdb

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.event.inputs.release_name }}
          tag_name: ${{ github.event.inputs.tag }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: |
            DAMX-GUI.tar.xz
            DivAcerManagerMax.pdb.tar.xz
          files: |
            DAMX-GUI.tar.xz
            DivAcerManagerMax.pdb.tar.xz
